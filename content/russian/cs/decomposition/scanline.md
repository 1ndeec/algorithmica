---
title: Сканирующая прямая
---


> Посчитать число беспорядков в перестановке из $n$ элементов (беспорядок или инверсия — это пара чисел $i < j$, для которых $p_i > p_j$).

Эта задача решается просто, если уметь писать сортировку слиянием вручную. Но мы пойдем по другому пути. Создадим ДО для суммы на $n$ элементов, изначально заполненное нулями. Теперь будем проходить по этому массиву слева направо. Когда обрабатываем очередное число $x$, будем делать две вещи:

* Запросим сумму от $k$ до $n$ в ДО.
* Добавим единичку в $k$-тую позицию в ДО.

Так мы для каждой инверсии учтём её, когда запросим сумму для её правого элемента. Таким образом, мы решили эту задачу за $O(n \log n)$ запросов.

> Даны $n$ точек на плоскости с целыми координатами от 1до $n$. Требуется ответить на $m$ запросов количества точек на прямоугольнике.

Ответим на все запросы в оффлайн, используя метод сканирующей прямой:

* Разобьем запросы суммы на прямоугольнике на два запроса суммы на префиксах — сумма на прямоугольнике $[x_1, x_2] \times [y_1, y_2]$ равна сумме на прямоугольнике $[0, x_2] \times [y_1, y_2]$ минус сумма на прямоугольнике $[0, x_1] \times [y_1, y_2]$.
* Отсортируем теперь все точки и префиксные запросы по их $x$. При этом, если у точки и запроса одинаковый $x$, то точка должна идти раньше.
* Пройдёмся по ним в таком порядке и будем решать задачу для одномерной суммы: у нас есть операция «сделать +1 в $y_i$» и «вывести сумму с $y_1$ по $y_2$».

---

## Сканлайн

Мы уже разбирали базовые задачи на сканлайн в теме С++.

## Повторение

Дано $n$ отрезков (задаются своим левым и правым концом) и $m$ точек,
требуется найти точку, которую покрывают наибольшее количество
отрезков.

## Идея

Мы могли бы для каждой точки, честно за $O(n)$ найти количество
отрезков, которые ее покрывают.

Но можно сделать это эффективнее, если обрабатывать отрезок, который мы
встречаем, сразу для всех точек, которые он покрывает.

## Решение

Сделаем события трех видов :

1\) Начинается новый отрезок в точке $x$

2\) Требуется ответить на запрос сколько отрезков покрывают данную точку
$x$.

3\) Закрывается отрезок в точке $x$.

Отсортируем запросу по координате и пройдемся по отсортированному списку
событий, поддерживая, сколько отрезков сейчас покрывают данную точку.

## Асимптотика

Сам проход работает за $O(n)$, но нам еще нужно отсортировать события,
поэтому суммарно решение работает за $O(n\\log(n))$

## Новая задача

Дано $n$ прямоугольников, требуется найти площадь их объединения.

## Идея

Пользуясь предыдущим подходом можно было бы создать события :

1\) прямоугольник начинается в точке $x$ и занимает отрезок с $y_{1}$
по $y_{2}$

2\) прямоугольник заканчивается в точке $x$ и занимает отрезок с
$y_{1}$ по $y_{2}$

Затем просто поддерживать массив для каждой точки по $y$-координате
сколько прямоугольников ее поддерживает и тогда для каждого
события, надо прибавить к ответу (разницу между $x$ этого события
и предыдущего) $\\cdot$ количество точек, которых покрывает хоть один
прямоугольник.

Это решение работает за $nY$, что достаточно долго, но теперь мы знаем
структуры, которая умеет такие запросы быстрее.